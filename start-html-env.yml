review:
  tags:
    - docker
    - miquido
  image: docker/compose:alpine-1.29.2
  stage: start_env
  before_script:
    - apk add --no-cache openssh
    - docker context create miquido-internal --description "Internal miquido docker at docker.miquido.net" --docker "host=ssh://docker.miquido.net"
    - docker version
    - docker-compose version
  script:
    - |
      cat <<EOT >> env.conf
      server {
          listen 80;
          root /var/www/$CI_PROJECT_NAME-$CI_COMMIT_REF_SLUG;
          index index.html index.htm;
          server_name $CI_PROJECT_NAME-$CI_COMMIT_REF_SLUG.gitlab.d.miquido.net;
          location / {
              try_files \$uri \$uri/ =404;
          }
      }
      EOT
    - ssh ubuntu@docker.miquido.net "rm -rf /docker/gitlab-dynamic-environments/sites/$CI_PROJECT_NAME-$CI_COMMIT_REF_SLUG"
    - scp -r build ubuntu@docker.miquido.net:/docker/gitlab-dynamic-environments/sites/$CI_PROJECT_NAME-$CI_COMMIT_REF_SLUG
    - scp env.conf ubuntu@docker.miquido.net:/docker/gitlab-dynamic-environments/nginx-config/$CI_PROJECT_NAME-$CI_COMMIT_REF_SLUG.conf
    - docker context use miquido-internal
    - docker exec gitlab-dynamic-env_nginx_1 /etc/init.d/nginx reload
  environment:
    name: review/$CI_COMMIT_REF_SLUG
    url: "https://$CI_PROJECT_NAME-$CI_COMMIT_REF_SLUG.gitlab.d.miquido.net"                                              # and set the variable produced in script to `environment:url`
    on_stop: stop_review
  when: manual
  only:
    - branches
  except:
    - main